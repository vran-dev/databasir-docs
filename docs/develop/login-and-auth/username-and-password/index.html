<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.46">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>用户名密码登录解析 | Databasir</title><meta name="description" content="一个简单易用的数据库元数据管理平台！">
    <link rel="modulepreload" href="/assets/app.66e66754.js"><link rel="modulepreload" href="/assets/index.html.dc2be1ef.js"><link rel="modulepreload" href="/assets/index.html.78f78dce.js"><link rel="prefetch" href="/assets/index.html.af5185a8.js"><link rel="prefetch" href="/assets/index.html.43c2f825.js"><link rel="prefetch" href="/assets/v1.0.6-migration.html.654d1a4d.js"><link rel="prefetch" href="/assets/_sidebar.html.5313e992.js"><link rel="prefetch" href="/assets/index.html.cc4c205f.js"><link rel="prefetch" href="/assets/index.html.6c774a00.js"><link rel="prefetch" href="/assets/index.html.55243d54.js"><link rel="prefetch" href="/assets/index.html.f7adf757.js"><link rel="prefetch" href="/assets/index.html.ae21434f.js"><link rel="prefetch" href="/assets/index.html.0556544c.js"><link rel="prefetch" href="/assets/index.html.2e8d98ec.js"><link rel="prefetch" href="/assets/index.html.b3df3ad2.js"><link rel="prefetch" href="/assets/index.html.26b9236c.js"><link rel="prefetch" href="/assets/index.html.761d32e9.js"><link rel="prefetch" href="/assets/index.html.f2e72675.js"><link rel="prefetch" href="/assets/index.html.450976b6.js"><link rel="prefetch" href="/assets/index.html.e1b9106a.js"><link rel="prefetch" href="/assets/docker-deploy.html.53f424f3.js"><link rel="prefetch" href="/assets/jar-deploy.html.272fcb76.js"><link rel="prefetch" href="/assets/index.html.6915ac7b.js"><link rel="prefetch" href="/assets/index.html.04450883.js"><link rel="prefetch" href="/assets/index.html.23b5d21a.js"><link rel="prefetch" href="/assets/index.html.378e5f4f.js"><link rel="prefetch" href="/assets/index.html.5f570c3b.js"><link rel="prefetch" href="/assets/index.html.e00eb41e.js"><link rel="prefetch" href="/assets/404.html.c27e39d7.js"><link rel="prefetch" href="/assets/index.html.083410b6.js"><link rel="prefetch" href="/assets/index.html.9253e89f.js"><link rel="prefetch" href="/assets/v1.0.6-migration.html.21d5226d.js"><link rel="prefetch" href="/assets/_sidebar.html.a6d01729.js"><link rel="prefetch" href="/assets/index.html.494cc79e.js"><link rel="prefetch" href="/assets/index.html.ce5eba27.js"><link rel="prefetch" href="/assets/index.html.2e5f35f3.js"><link rel="prefetch" href="/assets/index.html.1857627d.js"><link rel="prefetch" href="/assets/index.html.9c1aa1b2.js"><link rel="prefetch" href="/assets/index.html.1bb40c54.js"><link rel="prefetch" href="/assets/index.html.1cc41d56.js"><link rel="prefetch" href="/assets/index.html.7dc70e99.js"><link rel="prefetch" href="/assets/index.html.328d874c.js"><link rel="prefetch" href="/assets/index.html.cdc49bce.js"><link rel="prefetch" href="/assets/index.html.35b8569a.js"><link rel="prefetch" href="/assets/index.html.ffe3d259.js"><link rel="prefetch" href="/assets/index.html.ced3227e.js"><link rel="prefetch" href="/assets/docker-deploy.html.1a1c1b4e.js"><link rel="prefetch" href="/assets/jar-deploy.html.30fd4e77.js"><link rel="prefetch" href="/assets/index.html.3e5b61ae.js"><link rel="prefetch" href="/assets/index.html.ef1dd4ab.js"><link rel="prefetch" href="/assets/index.html.57d64d9a.js"><link rel="prefetch" href="/assets/index.html.64b49985.js"><link rel="prefetch" href="/assets/index.html.cd20bede.js"><link rel="prefetch" href="/assets/index.html.05c5ce7c.js"><link rel="prefetch" href="/assets/404.html.2856b48c.js"><link rel="prefetch" href="/assets/404.119d63a5.js"><link rel="prefetch" href="/assets/Layout.d9a82ef5.js">
    <link rel="stylesheet" href="/assets/style.a9018f45.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name">Databasir</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/guid/index/" class="" aria-label="入门指南"><!--[--><!--]--> 入门指南 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="常见问题"><span class="title">常见问题</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="常见问题"><span class="title">常见问题</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/faq/" class="" aria-label="数据库相关"><!--[--><!--]--> 数据库相关 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/changelog/" class="" aria-label="版本记录"><!--[--><!--]--> 版本记录 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/develop/" class="router-link-active" aria-label="开发指南"><!--[--><!--]--> 开发指南 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/donate/index.md/" class="" aria-label="捐赠"><!--[--><!--]--> 捐赠 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/vran-dev/databasir" rel="noopener noreferrer" target="_blank" aria-label="Gtihub"><!--[--><!--]--> Gtihub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/guid/index/" class="" aria-label="入门指南"><!--[--><!--]--> 入门指南 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="常见问题"><span class="title">常见问题</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="常见问题"><span class="title">常见问题</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/faq/" class="" aria-label="数据库相关"><!--[--><!--]--> 数据库相关 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/changelog/" class="" aria-label="版本记录"><!--[--><!--]--> 版本记录 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/develop/" class="router-link-active" aria-label="开发指南"><!--[--><!--]--> 开发指南 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/donate/index.md/" class="" aria-label="捐赠"><!--[--><!--]--> 捐赠 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/vran-dev/databasir" rel="noopener noreferrer" target="_blank" aria-label="Gtihub"><!--[--><!--]--> Gtihub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">项目构建 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/develop/how-to-build/index.md" class="sidebar-item" aria-label="后端构建"><!--[--><!--]--> 后端构建 <!--[--><!--]--></a><!----></li><li><a href="/develop/module-and-package/index.md" class="sidebar-item" aria-label="项目模块"><!--[--><!--]--> 项目模块 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading">功能扩展 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/develop/how-to-add-export-type/index.md" class="sidebar-item" aria-label="如何扩展文件导出？"><!--[--><!--]--> 如何扩展文件导出？ <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading active">系统原理 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/develop/login-and-auth/username-and-password/index.md" class="sidebar-item active" aria-label="用户名密码登录流程原理"><!--[--><!--]--> 用户名密码登录流程原理 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="用户名密码登录解析" tabindex="-1"><a class="header-anchor" href="#用户名密码登录解析" aria-hidden="true">#</a> 用户名密码登录解析</h1><h2 id="相关代码位置" tabindex="-1"><a class="header-anchor" href="#相关代码位置" aria-hidden="true">#</a> 相关代码位置</h2><p>相关代码都位于 <code>API</code> 模块下的</p><ul><li>【package】com.databasir.api.config.security.*</li><li>【class】com.databasir.api.config.SecurityConfig.java</li></ul><h2 id="登录认证过滤器" tabindex="-1"><a class="header-anchor" href="#登录认证过滤器" aria-hidden="true">#</a> 登录认证过滤器</h2><p>Databasir 的登录认证都是在 Filter 中实现的，目前有两个自定义的 Filter</p><ul><li><code>DatabasirOauth2LoginFilter</code>：负责处理 OAuth2 登录的请求</li><li><code>DatabasirJwtTokenFilter</code>：负责验证登录凭证的有效性</li></ul><p>用户名和密码的登录采用 Spring Security 自带的 Filter</p><ul><li><code>UsernamePasswordAuthenticationFilter</code>：负责处理用户名密码登录的请求</li></ul><p>用户登录请求都会经过这三个过滤器</p><p><img src="/assets/1-filter.7a1d666e.png" alt=""></p><p>由于本篇主要说明用户明密码登录这一流程，所以会重点专注于 <code>UsernamePasswordFilter</code> 这一过滤器。</p><h2 id="登录认证相关类" tabindex="-1"><a class="header-anchor" href="#登录认证相关类" aria-hidden="true">#</a> 登录认证相关类</h2><p>用户名密码登录是基于 Spring Security 提供的 <code>UsernamePasswordAuthenticationFilter</code> 实现。</p><p>Databasir 根据该过滤器的扩展点自定义了以下类</p><ul><li>DatabasirAuthenticationFailureHandler：登录失败回调</li><li>DatabasirAuthenticationSuccessHandler：登录成功回调</li><li>DatabasirUserDetailService：获取用户登录信息的 service</li><li>DatabasirUserDetails：用户的登录信息（扩展了角色信息）</li></ul><p>这些类的装配都在 <code>com.databasir.api.config.SecurityConfig.java</code> 中，下面展示了一部分源码，重点关注 <code>configure(HttpSecurity)</code> 方法</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DatabasirUserDetailService</span> databasirUserDetailService<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DatabasirAuthenticationEntryPoint</span> databasirAuthenticationEntryPoint<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DatabasirJwtTokenFilter</span> databasirJwtTokenFilter<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DatabasirAuthenticationFailureHandler</span> databasirAuthenticationFailureHandler<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DatabasirAuthenticationSuccessHandler</span> databasirAuthenticationSuccessHandler<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        http<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">frameOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        http<span class="token punctuation">.</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        http<span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sessionCreationPolicy</span><span class="token punctuation">(</span><span class="token class-name">SessionCreationPolicy</span><span class="token punctuation">.</span>STATELESS<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// 启用 form 表单登录方式，配置登录地址为 /login，并制定成功和失败的回调处理类</span>
                <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">failureHandler</span><span class="token punctuation">(</span>databasirAuthenticationFailureHandler<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">successHandler</span><span class="token punctuation">(</span>databasirAuthenticationSuccessHandler<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// 登录和 Token 刷新无需授权</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Routes<span class="token punctuation">.</span>Login</span><span class="token punctuation">.</span>REFRESH_ACCESS_TOKEN<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// oauth 回调地址无需鉴权</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/oauth2/apps&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/oauth2/authorization/*&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/oauth2/login/*&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// 静态资源无需鉴权</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/*.html&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/js/**&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/css/**&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/img/**&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/*.ico&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// api 请求需要授权</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/api/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">exceptionHandling</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">authenticationEntryPoint</span><span class="token punctuation">(</span>databasirAuthenticationEntryPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>

        http<span class="token punctuation">.</span><span class="token function">addFilterBefore</span><span class="token punctuation">(</span>
                databasirJwtTokenFilter<span class="token punctuation">,</span>
                <span class="token class-name">UsernamePasswordAuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这里指定了 userDetailService 为自定义的 DatabasirUserDetailService</span>
        auth<span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>databasirUserDetailService<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token function">bCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="登录认证过滤器处理流程" tabindex="-1"><a class="header-anchor" href="#登录认证过滤器处理流程" aria-hidden="true">#</a> 登录认证过滤器处理流程</h2><p>当请求经过 <code>UsernamePasswordAuthenticationFilter</code> 时，该过滤器会校验请求的路径是否是 <code>/login</code> ，如果不是的话就直接放行。</p><p>然后在从请求参数里面获取用户名和密码</p><ul><li>username</li><li>password</li></ul><p>再之后使用 <code>DatabasirUserDetailsService</code> 根据用户名获取实际的用户信息，将实际的密码和登录时传的参数做比较</p><ul><li>如果不一致就登录失败，调用 <code>DatabasirAuthenticationFailureHandler</code></li><li>如果一致就说明登录成功，调用 <code>DatabasirAuthenticationSuccessHandler</code></li></ul><p>下图展示了一个简化的代码调用时序</p><p><img src="/assets/2-username-and-password-filter.73e0fbb0.png" alt=""></p><h2 id="登录成功回调" tabindex="-1"><a class="header-anchor" href="#登录成功回调" aria-hidden="true">#</a> 登录成功回调</h2><p>当用户名密码认证通过以后就会触发<strong>登录成功回调</strong>（代码实现在<code>DatabasirAuthenticationSuccessHandler</code>），这里主要做一件事情</p><ul><li>生成登录凭证：access_token、refresh_token</li></ul><p>access_token 是请求接口的凭证，证明你是合法的登录用户，时效性是以分钟为单位，格式为 JWT。</p><p>refresh_token 是用于在 access_token 过期时，用于获取新的 access_token，时效性是以天为单位。</p><p>这些信息都存储在 login 表里，login 表与 user 表是一对一的关系</p><p><img src="/assets/3-token.ccb271f7.png" alt=""></p><p>access_token 和 refresh_token 最终都会返回给前端，前端拿到 token 以后调用业务接口都需在请求中加入 名为 Authorization 的 Header，值为 access_token</p><div class="language-http ext-http line-numbers-mode"><pre class="language-http"><code>POST /api/v1.0/groups

<span class="token header"><span class="token header-name keyword">Authorization</span><span class="token punctuation">:</span> <span class="token header-value">{{ access_token }}</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果 access_token 过期，前端会拿 refresh_token 获取一个新的 access_token，然后再调用业务接口，这些过程对用户是透明的。</p><h2 id="登录失败回调" tabindex="-1"><a class="header-anchor" href="#登录失败回调" aria-hidden="true">#</a> 登录失败回调</h2><p>当用户名密码认证没通过的时候机会触发登录失败回调，源码位于 <code>DatabasirAuthenticationFailureHandler</code> 中。</p><p>失败的回调会判断异常类型做出不同的响应</p><ul><li>BadCredentialsException：响应 200，用户名或密码错误</li><li>DisabledException：响应 200，用户已禁用</li><li>DatabasirAuthenticationException：响应 200，自定义登录异常</li><li>其他：响应 401</li></ul></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: vran_dev@foxmail.com">vran</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.66e66754.js" defer></script>
  </body>
</html>
